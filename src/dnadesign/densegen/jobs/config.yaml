# densegen/config.yaml

densegen:
  inputs:
    - name: 60bp_dual_promoter_cpxR_LexA
      type: csv_tfbs
      path: inputs/tf2tfbs_mapping_cpxR_LexA.csv

  output:
    kind: usr               # usr | jsonl | both
    jsonl:
      path: outputs/60bp_dual_promoter_cpxR_LexA.jsonl

  usr:
    dataset: 60bp_dual_promoter_cpxR_LexA
    root: null
    namespace: densegen
    chunk_size: 10
    allow_overwrite: true

  generation:
    sequence_length: 60
    quota: 30000
    sampling:
      subsample_over_length_budget_by: 120
      cover_all_tfs: true              # â‰¥1 TFBS per TF
      unique_binding_sites: true       # no duplicate TFBS strings
      max_sites_per_tf: null           # (optional) allow extra per TF after coverage
      relax_on_exhaustion: true

    plan:
      - name: sigma70_high
        quota: 10000
        fixed_elements:
          promoter_constraints:
            upstream: "TTGACA"
            downstream: "TATAAT"
            spacer_length: [16, 18]
            upstream_pos: [0, 60]
      - name: sigma70_mid
        quota: 10000
        fixed_elements:
          promoter_constraints:
            upstream: "ACCGCG"
            downstream: "TATAAT"
            spacer_length: [16, 18]
            upstream_pos: [0, 60]
      - name: sigma70_low
        quota: 10000
        fixed_elements:
          promoter_constraints:
            upstream: "GCAGGT"
            downstream: "TATAAT"
            spacer_length: [16, 18]
            upstream_pos: [0, 60]

  solver:
    backend: GUROBI                      # chosen once at startup; if probe fails we fall back to CBC
    diverse_solution: true
    options:
      - "Threads=16"
      - "TimeLimit=10"

  runtime:
    round_robin: true
    arrays_generated_before_resample: 20
    require_min_count_per_tf: true  # enforce >= 1 site per TF in the final solution (post-solve check).
    # min_count_per_tf: 1   # (optional, overrides the boolean above if provided)
    max_duplicate_solutions: 3
    stall_seconds_before_resample: 5
    stall_warning_every_seconds: 15
    max_resample_attempts: 3
    random_seed: 42

  postprocess:
    fill_gap: true
    fill_gap_end: "5prime"
    fill_gc_min: 0.40
    fill_gc_max: 0.60

  logging:
    level: INFO
    suppress_solver_stderr: true       # dedupe native CBC "parameters as string not supported" spam
    print_visual: true                 # print the ILP visual per solution (fresh line, un-clipped)

plots:
  out_dir: outputs/plots

  # Global style applied to every plot (can be overridden per-plot)
  style:
    font_size: 14
    palette: okabe_ito          # name, list of colors, or single color (per-plot overrides allowed)
    seaborn_style: true
    despine: true
    legend_frame: false
    # Optional:
    # promoter_colors:
    #   "-35 site": "#D55E00"
    #   "-10 site": "#0072B2"

  default:
    - compression_ratio
    - tf_usage
    - tfbs_usage
    - plan_counts
    - tf_coverage
    - tfbs_length_density
    - gap_fill_gc

  options:

    compression_ratio:
      dims: [6, 6]
      # bins: 30

    tf_usage:
      dims: [8, 6]
      mode: stack_lengths        # stack_lengths | stack_tfbs | totals
      max_segments: 20
      top_k_tfs: null
      # palette can be overridden here; palette_no_repeat enforces unique colors
      # palette: tab20
      # palette_no_repeat: true

    tfbs_usage:
      dims: [32, 6]
      couple_sigma_pairs: true   # unmapped/None plans are skipped (no errors)
      exclude_tfbs: ["G"]
      # max_sites: 60

    plan_counts:
      dims: [6, 6]
      stacked_by_day: true
      created_at_col: created_at

    tf_coverage:
      dims: [16, 3]
      top_k: 20
      normalize: false
      stacked: false
      alpha: 0.35                 # bar face opacity
      palette: seagreen           # single color, palette name, or list
      edge_on: true               # toggle per-bin edges
      edge_width: 1.9             # thickness (pt)
      edge_alpha: 0.9             # opacity
      edge_color: auto            # auto=darker(face); or a fixed color (#333, 'k', etc.)
      edge_dark_factor: 0.80      # only used when edge_color=auto

      include_promoter_sites: true
      promoter_scan_revcomp: false
      promoter_edge_style: solid
      # promoter_edge_alpha: 0.95
      # promoter_on_top: true
      # promoter_zorder: 4.0

    tfbs_length_density:
      dims: [6, 6]
      kde: true
      # bins: auto               # when kde=false
      kde_bandwidth: null
      kde_points: 256
      fill_alpha: 0.35
      include_promoter_sites: false
      promoter_scan_revcomp: false

    gap_fill_gc:
      dims: [6, 6]
