# DenseGen demo: Stage-A sampling baseline with stress-response TF artifacts.
densegen:
  schema_version: "2.9"
  run:
    id: demo_sampling_baseline
    root: "."

  motif_sets:
    sigma70_upstream_35:
      consensus: TTGACA
    sigma70_downstream_10:
      consensus: TATAAT

  inputs:
    # LexA + CpxR + BaeR artifacts exported from the Cruncher handoff workflow.
    - name: lexA_pwm
      type: pwm_artifact
      path: inputs/motif_artifacts/lexA__demo_merged_meme_oops_multitf__lexA_CTGTATAWAWWHACA.json
      sampling:
        strategy: stochastic
        n_sites: 100
        mining:
          batch_size: 2000
          budget:
            mode: fixed_candidates
            candidates: 150000
            growth_factor: 1.25
          log_every_batches: 1
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: core
          cross_regulator_core_collisions: error
        selection:
          policy: mmr
          rank_by: score_norm
          alpha: 0.35
          pool:
            min_score_norm: 0.75
            max_candidates: null
            relevance_norm: minmax_raw_score
        tier_fractions: [0.001, 0.01, 0.09]
    - name: cpxR_pwm
      type: pwm_artifact
      path: inputs/motif_artifacts/cpxR__demo_merged_meme_oops_multitf__cpxR_MANWWHTTTAM.json
      sampling:
        strategy: stochastic
        n_sites: 100
        mining:
          batch_size: 2000
          budget:
            mode: fixed_candidates
            candidates: 150000
            growth_factor: 1.25
          log_every_batches: 1
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: core
          cross_regulator_core_collisions: error
        selection:
          policy: mmr
          rank_by: score_norm
          alpha: 0.35
          pool:
            min_score_norm: 0.75
            max_candidates: null
            relevance_norm: minmax_raw_score
        tier_fractions: [0.001, 0.01, 0.09]
    - name: baeR_pwm
      type: pwm_artifact
      path: inputs/motif_artifacts/baeR__demo_merged_meme_oops_multitf__baeR_TTTCTSCVHNA.json
      sampling:
        strategy: stochastic
        n_sites: 100
        mining:
          batch_size: 2000
          budget:
            mode: fixed_candidates
            candidates: 150000
            growth_factor: 1.25
          log_every_batches: 1
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: core
          cross_regulator_core_collisions: error
        selection:
          policy: mmr
          rank_by: score_norm
          alpha: 0.35
          pool:
            min_score_norm: 0.75
            max_candidates: null
            relevance_norm: minmax_raw_score
        tier_fractions: [0.001, 0.01, 0.09]
    - name: background
      type: background_pool
      sampling:
        n_sites: 200
        mining:
          batch_size: 10000
          budget:
            mode: fixed_candidates
            candidates: 600000
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: sequence
        gc:
          min: 0.40
          max: 0.60
        filters:
          fimo_exclude:
            pwms_input: [lexA_pwm, cpxR_pwm, baeR_pwm]
            allow_zero_hit_only: true
          forbid_kmers: [TTGACA, TATAAT]
          include_reverse_complements: true
          strands: both

  output:
    targets: [parquet, usr]
    schema:
      bio_type: dna
      alphabet: dna_4
    parquet:
      path: outputs/tables/records.parquet
      deduplicate: true
      chunk_size: 64
    usr:
      root: outputs/usr_datasets
      dataset: densegen/demo_sampling_baseline
      chunk_size: 64
      health_event_interval_seconds: 60

  generation:
    sequence_length: 60
    sampling:
      pool_strategy: subsample
      library_size: 10
      library_sampling_strategy: tf_balanced
      unique_binding_sites: true
      unique_binding_cores: true
      max_sites_per_regulator: null
      relax_on_exhaustion: false

    plan:
      - name: ethanol
        sequences: 6
        sampling:
          include_inputs: [cpxR_pwm, baeR_pwm, background]
        fixed_elements:
          promoter_constraints:
            - name: sigma70_consensus
              upstream: TTGACA
              downstream: TATAAT
              spacer_length: [16, 20]
              upstream_pos: [0, 60]
        regulator_constraints:
          groups:
            - name: ethanol_response
              members:
                - cpxR_MANWWHTTTAM
                - baeR_TTTCTSCVHNA
              min_required: 1
      - name: ciprofloxacin
        sequences: 6
        sampling:
          include_inputs: [lexA_pwm, background]
        fixed_elements:
          promoter_constraints:
            - name: sigma70_consensus
              upstream: TTGACA
              downstream: TATAAT
              spacer_length: [16, 18]
              upstream_pos: [0, 60]
        regulator_constraints:
          groups:
            - name: ciprofloxacin_response
              members:
                - lexA_CTGTATAWAWWHACA
              min_required: 1
    sequence_constraints:
      forbid_kmers:
        - name: forbid_sigma70_hexamers
          patterns_from_motif_sets:
            - sigma70_upstream_35
            - sigma70_downstream_10
          include_reverse_complements: true
          strands: both
      allowlist:
        - kind: fixed_element_instance
          selector:
            fixed_element: promoter
            component: [upstream, downstream]

  solver:
    backend: CBC
    strategy: iterate
    time_limit_seconds: 5

  runtime:
    round_robin: true
    arrays_generated_before_resample: 2
    min_count_per_tf: 0
    max_duplicate_solutions: 3
    stall_seconds_before_resample: 10
    stall_warning_every_seconds: 10
    max_consecutive_failures: 25
    max_seconds_per_plan: 60
    max_failed_solutions: 5000
    max_failed_solutions_per_target: 2.0
    random_seed: 42

  postprocess:
    pad:
      mode: adaptive
      end: 5prime
      gc:
        mode: range
        min: 0.40
        max: 0.60
        target: 0.50
        tolerance: 0.10
        min_pad_length: 0
      max_tries: 2000

  logging:
    log_dir: outputs/logs
    level: INFO
    suppress_solver_stderr: true
    print_visual: true
    visuals:
      tf_colors:
        lexA: "#66C2A5"
        cpxR: "#FC8D62"
        baeR: "#8DA0CB"
        background: "#B3B3B3"
        sigma70_consensus: "#E78AC3"
    progress_style: auto
    progress_every: 1
    progress_refresh_seconds: 1.0

plots:
  source: usr
  out_dir: outputs/plots
  format: pdf
  default: [stage_a_summary, placement_map, run_health, tfbs_usage]
