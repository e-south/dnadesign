# DenseGen study workspace: constitutive sigma70 promoter core combinatorics panel.
densegen:
  schema_version: "2.9"
  run:
    id: study_constitutive_sigma_panel
    root: "."

  motif_sets:
    sigma70_upstream_35:
      a: CCCGGG
      b: CTGACA
      c: TTGTGA
      d: TTTACA
      e: TAGACA
      f: TTGACA
    sigma70_downstream_10:
      A: CCAGTC
      B: TATGTT
      C: TACTGT
      D: TAAATT
      E: GATACT
      F: GATAAT
      G: TATAGT
      H: TATAAT

  inputs:
    - name: lacI_pwm
      type: pwm_artifact
      path: inputs/motif_artifacts/lacI__pairwise_laci_arac_merged_meme_oops__lacI_WWWTGTGAGCGNDTMACAA.json
      sampling:
        strategy: stochastic
        n_sites: 150
        mining:
          batch_size: 5000
          budget:
            mode: fixed_candidates
            candidates: 1200000
            growth_factor: 1.25
          log_every_batches: 1
        length:
          policy: range
          range: [16, 20]
        trimming:
          window_length: 16
        uniqueness:
          key: core
          cross_regulator_core_collisions: error
        selection:
          policy: mmr
          rank_by: score_norm
          alpha: 0.35
          pool:
            min_score_norm: 0.75
            max_candidates: null
            relevance_norm: minmax_raw_score
        tier_fractions: [0.001, 0.01, 0.09]
    - name: araC_pwm
      type: pwm_artifact
      path: inputs/motif_artifacts/araC__pairwise_laci_arac_merged_meme_oops__araC_TAKSRATWWWHHCSMTA.json
      sampling:
        strategy: stochastic
        n_sites: 150
        mining:
          batch_size: 5000
          budget:
            mode: fixed_candidates
            candidates: 1200000
            growth_factor: 1.25
          log_every_batches: 1
        length:
          policy: range
          range: [16, 20]
        trimming:
          window_length: 16
        uniqueness:
          key: core
          cross_regulator_core_collisions: error
        selection:
          policy: mmr
          rank_by: score_norm
          alpha: 0.35
          pool:
            min_score_norm: 0.75
            max_candidates: null
            relevance_norm: minmax_raw_score
        tier_fractions: [0.001, 0.01, 0.09]
    - name: background
      type: background_pool
      sampling:
        n_sites: 1200
        mining:
          batch_size: 25000
          budget:
            mode: fixed_candidates
            candidates: 8000000
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: sequence
        gc:
          min: 0.40
          max: 0.60
        filters:
          fimo_exclude:
            pwms_input: [lacI_pwm, araC_pwm]
            allow_zero_hit_only: true
          forbid_kmers:
            - patterns_from_motif_sets:
                - sigma70_upstream_35
                - sigma70_downstream_10
              include_reverse_complements: true
              strands: both

  output:
    targets: [parquet, usr]
    schema:
      bio_type: dna
      alphabet: dna_4
    parquet:
      path: outputs/tables/records.parquet
      deduplicate: true
      chunk_size: 128
    usr:
      root: outputs/usr_datasets
      dataset: densegen/study_constitutive_sigma_panel
      chunk_size: 128
      health_event_interval_seconds: 60

  generation:
    sequence_length: 90
    expansion:
      max_plans: 64
    sampling:
      pool_strategy: subsample
      library_size: 16
      library_sampling_strategy: tf_balanced
      unique_binding_sites: true
      unique_binding_cores: true
      max_sites_per_regulator: null
      relax_on_exhaustion: false

    plan:
      - name: sigma70_panel
        sequences: 48
        expanded_name_template: "{base}__sig35={up}__sig10={down}"
        sampling:
          include_inputs: [background]
        fixed_elements:
          fixed_element_matrix:
            name: sigma70_core
            upstream_from_set: sigma70_upstream_35
            downstream_from_set: sigma70_downstream_10
            pairing:
              mode: cross_product
            spacer_length: [16, 18]
            upstream_pos: [0, 90]
        regulator_constraints:
          groups: []

    sequence_constraints:
      forbid_kmers:
        - name: forbid_sigma_hexamers
          patterns_from_motif_sets:
            - sigma70_upstream_35
            - sigma70_downstream_10
          include_reverse_complements: true
          strands: both
      allowlist:
        - kind: fixed_element_instance
          selector:
            fixed_element: promoter
            component: [upstream, downstream]

  solver:
    backend: CBC
    strategy: iterate
    time_limit_seconds: 5

  runtime:
    round_robin: true
    arrays_generated_before_resample: 2
    min_count_per_tf: 0
    max_duplicate_solutions: 3
    stall_seconds_before_resample: 10
    stall_warning_every_seconds: 10
    max_consecutive_failures: 25
    max_seconds_per_plan: 1800
    max_failed_solutions: 256
    random_seed: 42

  postprocess:
    pad:
      mode: adaptive
      end: 5prime
      gc:
        mode: range
        min: 0.40
        max: 0.60
        target: 0.50
        tolerance: 0.10
        min_pad_length: 0
      max_tries: 2000

  logging:
    log_dir: outputs/logs
    level: INFO
    progress_style: auto

plots:
  source: parquet
  out_dir: outputs/plots
  format: pdf
  default: [stage_a_summary, placement_map, run_health, tfbs_usage]
  options:
    placement_map:
      scope: auto
      max_plans: 12
    tfbs_usage:
      scope: auto
      max_plans: 12
