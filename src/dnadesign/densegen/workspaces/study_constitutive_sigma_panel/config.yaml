# DenseGen study workspace: constitutive sigma70 promoter core combinatorics panel.
densegen:
  schema_version: "2.9"
  run:
    id: study_constitutive_sigma_panel
    root: "."

  motif_sets:
    sigma70_upstream_35:
      a: CCCGGG
      b: CTGACA
      c: TTGTGA
      d: TTTACA
      e: TAGACA
      f: TTGACA
    sigma70_downstream_10:
      A: CCAGTC
      B: TATGTT
      C: TACTGT
      D: TAAATT
      E: GATACT
      F: GATAAT
      G: TATAGT
      H: TATAAT

  inputs:
    - name: background
      type: background_pool
      sampling:
        n_sites: 1200
        mining:
          batch_size: 20000
          budget:
            mode: fixed_candidates
            candidates: 2000000
        length:
          policy: range
          range: [16, 20]
        uniqueness:
          key: sequence
        gc:
          min: 0.40
          max: 0.60
        filters:
          forbid_kmers:
            - CCCGGG
            - CTGACA
            - TTGTGA
            - TTTACA
            - TAGACA
            - TTGACA
            - CCAGTC
            - TATGTT
            - TACTGT
            - TAAATT
            - GATACT
            - GATAAT
            - TATAGT
            - TATAAT
          include_reverse_complements: true
          strands: both

  output:
    targets: [parquet, usr]
    schema:
      bio_type: dna
      alphabet: dna_4
    parquet:
      path: outputs/tables/records.parquet
      deduplicate: true
      chunk_size: 128
    usr:
      root: outputs/usr_datasets
      dataset: densegen/study_constitutive_sigma_panel
      chunk_size: 128
      health_event_interval_seconds: 60

  generation:
    sequence_length: 90
    plan_template_max_expanded_plans: 64
    plan_template_max_total_quota: 500
    sampling:
      pool_strategy: subsample
      library_size: 16
      library_sampling_strategy: tf_balanced
      unique_binding_sites: true
      unique_binding_cores: true
      max_sites_per_regulator: null
      relax_on_exhaustion: false

    plan_templates:
      - base_name: sigma70_panel
        total_quota: 480
        distribution_policy: uniform
        sampling:
          include_inputs: [background]
        fixed_elements:
          promoter_matrix:
            name: sigma70_core
            upstream_from_set: sigma70_upstream_35
            downstream_from_set: sigma70_downstream_10
            pairing:
              mode: cross_product
            spacer_length: [16, 18]
            upstream_pos: [0, 90]
        regulator_constraints:
          groups: []
      - base_name: sigma70_topup
        total_quota: 20
        distribution_policy: uniform
        sampling:
          include_inputs: [background]
        fixed_elements:
          promoter_matrix:
            name: sigma70_core
            upstream_from_set: sigma70_upstream_35
            downstream_from_set: sigma70_downstream_10
            pairing:
              mode: explicit_pairs
              pairs:
                - up: a
                  down: A
                - up: f
                  down: H
            spacer_length: [16, 18]
            upstream_pos: [0, 90]
        regulator_constraints:
          groups: []

    sequence_constraints:
      forbid_kmers:
        - name: forbid_sigma_hexamers
          patterns_from_motif_sets:
            - sigma70_upstream_35
            - sigma70_downstream_10
          include_reverse_complements: true
          strands: both
      allowlist:
        - kind: fixed_element_instance
          selector:
            fixed_element: promoter
            component: [upstream, downstream]

  solver:
    backend: CBC
    strategy: iterate
    time_limit_seconds: 5

  runtime:
    round_robin: true
    arrays_generated_before_resample: 2
    min_count_per_tf: 0
    max_duplicate_solutions: 3
    stall_seconds_before_resample: 10
    stall_warning_every_seconds: 10
    max_consecutive_failures: 25
    max_seconds_per_plan: 1800
    max_failed_solutions: 256
    random_seed: 42

  postprocess:
    pad:
      mode: adaptive
      end: 5prime
      gc:
        mode: range
        min: 0.40
        max: 0.60
        target: 0.50
        tolerance: 0.10
        min_pad_length: 0
      max_tries: 2000

  logging:
    log_dir: outputs/logs
    level: INFO
    progress_style: auto

plots:
  source: parquet
  out_dir: outputs/plots
  format: pdf
  default: [stage_a_summary, placement_map, run_health, tfbs_usage]
