# DenseGen Dev Journal

## 2026-02-03
- Started refactor to reduce DenseGen monoliths (orchestrator/CLI/config).
- Decisions: enforce strict no-fallback behavior across CLI/reporting; split config into submodules; extract pipeline phases; consolidate Stage-A modules; keep public imports stable via re-exports; add background progress + logos (prior commit).
- Extracted pipeline validation/usage helpers and Stage-A pool preparation into dedicated modules.
- Added shared sequence GC utility and corrected Stage-A import layering to eliminate circular imports.
- Extracted library artifact loading/writing into a dedicated pipeline helper with assertive parquet handling.
- Extracted resume-state loading into a dedicated pipeline helper.
- Extracted run-state initialization/writing into a dedicated pipeline helper.
- Split reporting into data and rendering modules; keep public facade stable.
- Added shared record value coercion helpers and removed duplicated list parsing.
- Fixed a run_metrics circular import by deferring plan_pools import to call site.
- Added shared event log parsing helpers and removed duplicated event loaders.

## 2026-02-04
- Fixed Stage-B stall handling for zero-solution generators: exit the library loop so stall detection triggers, and ensure max_consecutive_failures is enforced even with one_subsample_only.
- Tests: `uv run pytest -q src/dnadesign/densegen/tests/test_round_robin_chunk_cap.py`.
- Refactored `_process_plan_for_source` to delegate to `_run_stage_b_sampling`, separating plan setup, pool loading, and Stage-B execution.
- Tests: `uv run pytest -q src/dnadesign/densegen/tests/test_round_robin_chunk_cap.py src/dnadesign/densegen/tests/test_source_cache.py`.
- Profiling: Stage-A PWM build using `demo_meme_three_tfs` with `--max-seconds 2` (per-motif) wrote pools under `outputs/pools_profile`.
  Hotspots: `stage_a_mining.mine_pwm_candidates`, `pwm_fimo.run_fimo` + `subprocess.run`, `_generate_batch`.
  Stage-B profiling blocked: `neutral_bg` pool missing; need background pool build to proceed.
- Background pool negative selection now uses FIMO p-value threshold 1e-4 and scans both strands for hits.
- Demo config: increased `generation.sequence_length` to 64 so ethanol_ciprofloxacin plan meets minimum required bp (fixed + required motifs).
- Plan (densegen-refactor): holistic refactor + strict config default.
- Reverted demo `generation.sequence_length` to 60 to keep dense arrays fixed-length; Stage-B feasibility checks now warn (no abort) for short libraries or oversized motifs.
- Tests: `uv run pytest -q src/dnadesign/densegen/tests/test_stage_b_library_builder.py -k "allows_short_library_bp or allows_infeasible_min_required_len or allows_long_motif_length"`.
- Docs: run_metrics tier aggregations exclude background pools without tier labels.
- Refactored `TFSampler.generate_binding_site_library` with per-TF index caching and helper split.
- Moved Stage-A algorithmic modules to `core/stage_a`; adapters now re-export Stage-A modules.
- Stage-B sampling now reads typed config fields directly (no getattr defaults).
- Added DenseGen docs index at `docs/README.md`.
- Removed remaining Stage-B sampling fallbacks in `stage_b_library_builder`.
- Docs index now links to dev README + architecture.
- Assessment: background-pool negative selection uses FIMO p=1e-4 with allow_zero_hit_only; consider manifest metrics for reject counts + max_score_norm summaries.
- Assessment: background-pool FIMO exclusion runs once per motif per batch; consider single MEME run or cached motif files for throughput.
- Assessment: decide whether Stage-B feasibility errors for missing regulators should be treated as resample events instead of fatal.
- Stage-A progress settings now initialize during `dense run` Stage-A rebuilds; background pool progress streams in non-TTY mode.
- Added colorized DenseArray visuals in screen progress output with explicit `logging.visuals.tf_colors` mapping; no fallback for missing TF colors.
- Fixed DenseArray visual rendering when promoter constraints append motifs: extend visual labels with `__densegen__extra__`, update docs/demo config, and add tests.
- Fixed composition output to emit per-placement rows (solution_id/tf/tfbs/offset/length) so placement_map plots can run.
- Screen progress now includes an in-panel legend table plus global progress; shared dashboards prevent per-plan screen redraw spam.
- Console logging now suppresses fontTools INFO noise (kept in log file); demo palette updated to a more distinct set.
- Fixed-element labels now derive from `promoter_constraints[].name` (joined with `+`) and are used for DenseArray visuals/legend + optimizer regulator mapping.
- Screen legend now wraps into multiple rows to avoid wide panels and improve Live refresh behavior.
- Tests: added fixed-elements label helper test + custom extra-label visual test.
- Stage-B usage tracking now updates live during runs (tf_coverage/tfbs_coverage/tfbs_entropy reflect accepted solutions).
- Debugged Stage-B crash when visuals enabled: `logging.visuals.tf_colors` must map display TF labels (e.g., `lexA`,
  `background`); updated demo config + docs and aligned AGENTS auto-resume note.
- Ensured Matplotlib cache setup validates writability and demotes fontTools console noise; added tests for cache setup.
- [ ] Profile Stage-A and Stage-B (identify hotspots before algorithm changes).
- [x] Refactor `_process_plan_for_source` into helpers (plan setup, library build, solver loop, outputs).
- [x] Refactor `TFSampler.generate_binding_site_library` into validation, required-placement, sampling loop, metadata assembly, and add per-TF index to avoid repeated slicing.
- [x] Enforce strict config resolution by default (explicit `-c` or `DENSEGEN_CONFIG_PATH` only) and update tests/docs.
- [ ] Evaluate `USRWriter._load_existing_ids` vs id-index approach and decide on implementation.
- [x] Relocate Stage-A internals into `core/stage_a` and keep adapters thin.
- [x] Add docs index at `src/dnadesign/densegen/docs/README.md`.
- [x] Run DenseGen test subset and capture results.
- [ ] Profiling target workspace: TBD (need config path).

## 2026-02-10
- Audit scope: compared legacy USR dataset `60bp_dual_promoter_cpxR_LexA` against a fresh end-to-end DenseGen run (`/tmp/schema_audit_both_0210`) with `output.targets: [parquet, usr]`.
- Confirmed sink consistency for a same-run output: local `outputs/tables/dense_arrays.parquet` and USR merged view share identical values/types for all shared densegen columns.
- Decision: keep a single curated DenseGen schema under the `densegen__` namespace; no split "compact vs full" schemas.
- Decision: organize the one schema by hierarchical semantic prefixes (run/solver/input/stage_a/stage_b/placement/pad) while keeping `densegen__` as the USR namespace boundary.
- Key gap found: Stage-A PWM fields (`densegen__input_pwm_*`) are registered but all-null for plan-pool runs; retention work should either populate these from pooled sources or replace them with non-redundant populated summaries.
- Key gap found: record-level placement provenance includes ids and offsets (`densegen__used_tfbs_detail`) but not per-site score lineage (`best_hit_score`, tier, FIMO locus/strand, selection score) available in Stage-A pool tables.
- Retention direction: preserve sequence-level provenance and minimal join keys in records; demote repeated run constants to run-level manifests unless needed for direct USR-only analysis.
- Next implementation target: define an explicit retention matrix (keep/conditional/demote) and align metadata emission rules to avoid all-null and run-constant column sprawl.
- Implemented retention guards in metadata emission: non-`pwm_sampled` records now clear PWM-only fields (`input_pwm_*`, `input_pwm_ids`), and non-`binding_sites` records clear pair-specific fields (`input_tf_tfbs_pair_count`, `sampling_fraction_pairs`).
- Implemented Stage-A lineage propagation into `densegen__used_tfbs_detail` at record level: `stage_a_best_hit_score`, `stage_a_rank_within_regulator`, `stage_a_tier`, `stage_a_fimo_start`, `stage_a_fimo_stop`, `stage_a_fimo_strand`, `stage_a_selection_rank`, `stage_a_selection_score_norm`, and `stage_a_tfbs_core`.
- Updated Parquet/USR schema contract for `densegen__used_tfbs_detail` to keep sink parity, including USR registry type updates.
- Added tests for: Stage-A lineage in placement detail, retention/sparsity behavior by `input_mode`, and parity between Parquet and USR shared metadata columns.
- Fresh e2e schema audit run (temp workspace): `/tmp/densegen_audit_demo_meme_three_tfs` with current `demo_meme_three_tfs` config.
- Fresh run result: `dense_arrays.parquet` has 101 `densegen__*` columns (40 rows); 29 columns are all-null and 39 are run-constant in this run.
- Confirmed expanded placement lineage now materializes in fresh outputs: `densegen__used_tfbs_detail` includes Stage-A fields; non-null placement counts in this run were `stage_a_* = 68/120` placements (core/id/offset fields remain 120/120).
- Confirmed gap: `composition.parquet` currently stores placement identity/geometry (`tf`, `tfbs`, ids, offsets) but not `stage_a_*` fields, so Stage-A placement lineage is only present in nested `densegen__used_tfbs_detail`.
- Retention triage direction (single `densegen__` schema): keep sequence/placement provenance inline; move repeated run constants to `outputs/meta/*`; keep library/pool-level attributes in `outputs/libraries/*` and `outputs/pools/*` with stable join keys (`sampling_library_hash`, `library_index`, `tfbs_id`, `motif_id`).
- Applied curated DenseGen record schema contract from review: reduced `META_FIELDS` to the agreed field set and aligned Parquet + USR namespace registry.
- Added contract tests that pin: metadata schema keys, emitted metadata keys, and `usr/datasets/registry.yaml` densegen columns (including NPZ conditional columns).
- Updated resume-state loading to avoid relying on removed `densegen__run_config_sha256`; resume now keys off retained record columns (`run_id`, `input_name`, `plan`, `used_tfbs_detail`).
- Updated DenseGen outputs reference docs with explicit curated field catalog (field, retention class, meaning) for UX/dev discoverability.
- Docs alignment audit across DenseGen + USR + Notify: validated CLI contracts against current `uv run ... --help` outputs and corrected stale remote-sync examples.
- Updated USR sync/operator docs to positional remote syntax for `usr diff/pull/push` (for example `usr pull <dataset-or-path> bu-scc -y`), including DenseGen HPC runbooks and USR package docs.
- Clarified Notify README webhook-source contract for direct CLI mode and DenseGen outputs docs for USR-only NPZ columns.
- Refactored resume-state aggregation to stream output rows from sink loaders (`scan_records_from_config`) instead of materializing full output tables in pandas.
- Added streaming resume-state tests for aggregation correctness and run-id mismatch rejection.
- Refactored `USRSequencesDataSource` to stream `sequence` values from Parquet batches (no full-column `read_table`) and stop early at `limit`.
- Added regression test to enforce streaming behavior for `usr_sequences` input loading.
- Replaced `USRWriter` dedupe preload (`pq.read_table(..., columns=["id"])`) with SQLite-backed `IdIndex` lookups and index bootstrap from `records.parquet`.
- `USRWriter` now emits explicit actor payloads (`tool/run_id/host/pid`) into USR mutation/event calls instead of mutating `USR_ACTOR_*` environment variables.
- Added DenseGen regression tests for index-backed dedupe and explicit actor propagation in USR writer calls.
- Performance pass: `USRWriter.flush` now performs batch dedupe lookups via `IdIndex.contains_many` (single batched query path) instead of one `contains` query per record.
- Robustness fix: `USRWriter` now updates the id index after successful imports even when `deduplicate=False`, keeping `existing_ids()` and alignment digests correct.
- Decoupling pass: DenseGen USR loaders/sources now import `Dataset` from public `dnadesign.usr` API instead of internal `dnadesign.usr.src.*` modules.
- Test assurance audit pass (runtime/solver/USR): mapped existing coverage against Stage-A TFBS generation, solve-time constraint enforcement, Stage-B failure-aware sampling, and USR sink parity.
- Added always-on Stage-A PWM generation test by stubbing `sample_pwm_sites` in `PWMArtifactDataSource`; this removes dependence on FIMO availability for core TFBS row-generation assertions.
- Added runtime constraint test for `min_count_per_tf`: first solver candidate is rejected, second accepted; assertions include accepted sequence and `attempts.parquet` rejection reason `min_count_per_tf`.
- Added Stage-B failure-feedback test across successive library builds (`coverage_weighted` + `avoid_failed_motifs`) to verify aggregated failure counts are threaded into sampling and influence subsequent library composition.
- Added Stage-B usage-feedback test across successive library builds (`coverage_weighted`) to verify `usage_counts` are passed through and can steer subsequent library composition.
- Added runtime solver strategy coverage for non-iterate modes (`diverse`, `optimal`) to verify orchestrator wiring into optimizer build calls and run manifest recording.
- Added dedicated CI job `densegen-fimo` in `.github/workflows/ci.yaml` that installs pixi/MEME, verifies `fimo --version`, and runs the FIMO-gated DenseGen test suite via `pixi run pytest ...`.
- Validation commands: `uv run pytest -q src/dnadesign/densegen/tests/pwm/test_pwm_artifact_source.py src/dnadesign/densegen/tests/stage_b/test_required_regulators.py src/dnadesign/densegen/tests/stage_b/test_stage_b_library_builder.py`; `uv run pytest -q src/dnadesign/densegen/tests/stage_b src/dnadesign/densegen/tests/runtime/test_round_robin_chunk_cap.py src/dnadesign/densegen/tests/runtime/test_solver_integration_usr_resume.py src/dnadesign/densegen/tests/runtime/test_output_sink_parity.py src/dnadesign/densegen/tests/pwm/test_pwm_artifact_source.py`; `uv run ruff check ...` on touched files.
