job:
  name: retron_hp_swap
  bio_type: dna

  input:
    refs: "${JOB_DIR}/../inputs/refs.csv"
    name_col: "ref_name"
    seq_col: "sequence"
    reference_sequence: "retron_Eco1_msr_msd_wt"

  permute:
    protocol: "scan_stem_loop"
    params:
      # Bound the canonical hairpin by left/right flanks (forward strand)
      anchors:
        left:  "ATGCGCACCCTTAGCGAGAGGTTTATCATTAAGGTCAACCTCTGGATGTTGTTTCGGCATCCTGCATTGAATCTGAGTTACTGTCTGT"
        right: "CCCGTTTTTTCTGACGTAAGGGTGCGCA"
      seed:
        cap: "cgcctg"
      program:
        mode: rebuild
        grow_from: cap
        stem_len: {start: 4, stop: 32, step: 1}
        rng_seed: 42
        samples_per_length: 128
        gc_target: 0.50      # hold GC steady here
        strata:
          - id: match
            label: Fully matched (0%)
            overrides: { mismatch_rate: 0.00 }
          - id: mmlow
            label: Light mismatches (5%)
            overrides: { mismatch_rate: 0.05 }
          - id: mmmid
            label: Moderate mismatches (15%)
            overrides: { mismatch_rate: 0.15 }
          - id: mmhigh
            label: High mismatches (30%)
            overrides: { mismatch_rate: 0.30 }

      # bounded retries prevent stalling on early-length duplicates
      dedupe:
        retry_per_length: 32

  evaluate:
    metrics:
      - id: ll_mean
        evaluator: evo2_ll
        metric: log_likelihood
        params:
          model_id: evo2_7b
          device: cuda:0
          precision: bf16
          alphabet: dna
          reduction: mean
    #   - id: ll_sum
    #     evaluator: evo2_ll
    #     metric: log_likelihood
    #     params:
    #       model_id: evo2_7b
    #       device: cuda:0
    #       precision: bf16
    #       alphabet: dna
    #       reduction: sum
      # - id: fake_ll
      #   evaluator: placeholder
      #   metric: log_likelihood

  output:
    dir: "${JOB_DIR}/../results/retron_hp_swap"

  plot:
    which: ["hairpin_length_vs_metric"]
    metric_id: fake_ll
    size: {width: 9.5, height: 6.0}
    font_scale: 1.15
