job:
  name: retron_RT_combine_from_dms
  bio_type: dna

  input:
    refs: "${JOB_DIR}/../inputs/refs.csv"
    name_col: "ref_name"
    seq_col: "sequence"
    aa_col: "protein"  # optional; REF_AA.fa is handled by storage sidecar

  permute:
    protocol: "combine_aa"
    params:
      from_dataset: "${JOB_DIR}/../results/retron_Eco1_RT_wt_codon_scan/records.parquet"
      codon_table: "${JOB_DIR}/../inputs/codon_tables/codon_ecoli.csv"
      singles_metric_id: "llr_mean"

      select:
        top_global: 100
        min_delta: null
        allowed_positions: []
        exclude_positions: []
        exclude_mutations: []

      combine:
        k_min: 2
        k_max: 5
        budget_total: 5000
        strategy: "random"

      codon_choice: "top"
      rng_seed: 42

  evaluate:
    metrics:
      # - id: fake_ll
      #   evaluator: placeholder
      #   metric: log_likelihood

      - id: llr_mean
        evaluator: evo2_llr
        metric: log_likelihood_ratio
        params:
          model_id: evo2_7b
          device: cuda:0
          precision: bf16
          alphabet: dna
          reduction: mean

  output:
    dir: "${JOB_DIR}/../results/rt_combine_from_dms"

  plot:
    which:
      - ranked_variants
      - synergy_scatter
      - metric_by_mutation_count
    metric_id: llr_mean
    size: { width: 18.0, height: 5.5 }
    font_scale: 1.0
