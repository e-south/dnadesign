# Cruncher architecture

Cruncher is intentionally layered so that data access, optimization logic, and UX
can evolve independently without rewrites.

## Layers (ports & adapters)

- core/ — PWM model, scoring, evaluator, state, optimizers; **no I/O**.
- ingest/ — source adapters and normalization (RegulonDB first).
- store/ — local catalog cache + lockfiles; the only persistence layer.
- workflows/ — parse/sample/analyze/report orchestration.
- cli/ — Typer commands; no business logic.

Project-local cache root: `.cruncher/` (relative to config). No global state.
Run registry: `.cruncher/run_index.json` (used by `cruncher runs list/show`).

Source adapters are registered via a registry (plug-in style). Workflows only consume
catalog-backed PWMs and **never** reach out to the network directly.

Lockfiles are mandatory for parse/sample to keep TF resolution reproducible. Analyze/report consume
run artifacts and validate the lockfile recorded in the run manifest.

## Run lifecycle

1. **fetch** — populate `.cruncher/normalized/*` and update `catalog.json` (HT coordinates are hydrated via NCBI by default).
2. **lock** — resolve TF names → exact `(source, motif_id, sha256)` in `.cruncher/locks/`.
3. **parse** — validate/plot cached motifs, emit a `run_manifest.json`.
4. **sample** — MCMC optimization, emit `trace.nc`, `sequences.parquet`, `elites.parquet`, `run_manifest.json`.
5. **analyze** — diagnostic plots and scatter.
6. **report** — generate `report.json` and `report.md` from run artifacts.

Run folders use a timestamped slug with a short hash for disambiguation, for example:
`sample_set1_lexA-cpxR_20260101_143210_f3a9d2/`.

## Run artifacts (sample)

Each sample run directory contains:

- `config_used.yaml` — resolved runtime config + PWM summaries (used by analyze/report to avoid catalog drift).
- `trace.nc` — ArviZ-compatible trace (canonical trace format).
- `sequences.parquet` — per-draw sequences + per-TF scores.
- `cruncher_elites_*/` — elite sequences in `.parquet`, `.json`, and `.yaml`.
- `run_manifest.json` — provenance + resolved motifs + optimizer stats.
- `run_status.json` — live progress updates (written during parse and sampling).
- `report.json` / `report.md` — generated by `cruncher report`.

## Extensibility points

- **Sources**: add a new adapter under `ingest/adapters/` and register it.
- **Optimizers**: add a new MCMC kernel and register it in `core/optimizers/registry.py`.
- **Stores**: extend catalog layout or add new export formats without touching core logic.
