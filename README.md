# dnadesign

`dnadesign` is a collection of modular bioinformatic pipelines and helper packages related to biological sequence design.

- [Directory layout](#directory-layout)
- [Tools](#tools)
- [Installation](#installation)
  - [Local install](#local-install)
  - [Running dnadesign CLIs](#running-dnadesign-clis)
  - [Running notebooks](#running-notebooks)
- [Maintaining dependencies](#maintaining-dependencies)

---

### Directory layout

```text
dnadesign/
├─ README.md            # High-level project documentation
├─ pyproject.toml
├─ uv.lock
└── src/
    └── dnadesign/
        ├── permuter/    # in silico deep mutational scanning
        ├── infer/       # model-agnostic inference (Evo2 adapter)
        ├── densegen/    # string-packing nucleic acid assembly
        ├── opal/        # active-learning engine
        └── ...
```

---

### Tools

1. [**usr**](src/dnadesign/usr) (Universal Sequence Record)

      Consists of utility commands to inspect datasets/Parquet files used across the `dnadesign` project.

2. [**densegen**](src/dnadesign/densegen)

      DNA sequence design pipeline built on the integer linear programming framework from the [`dense-arrays`](https://github.com/e-south/dense-arrays) package.

2. [**infer**](src/dnadesign/infer)

      Model-agnostic wrapper for DNA/protein language models (e.g., [Evo2](https://github.com/ArcInstitute/evo2/tree/main)).

3. [**opal**](src/dnadesign/opal)

      An [EVOLVEpro-style](https://www.science.org/doi/10.1126/science.adr6006) active-learning tool for DNA/protein sequence design campaigns.

3. [**cluster**](src/dnadesign/cluster)

      A Parquet/CSV-first tool for Leiden clustering, UMAP visualisation, and a mix of other analyses.

4. [**billboard**](src/dnadesign)

      Quantifies the regulatory diversity of dense-array DNA libraries generated by **densegen**.

5.  [**libshuffle**](src/dnadesign/libshuffle)

      Iteratively subsamples sequence libraries from the sibling **sequences** directory and computes diversity metrics using the **billboard** pipeline as its engine.

6.	[**nmf**](src/dnadesign/nmf)

      Applies Non-Negative Matrix Factorization (NMF) to a library of sequences generated by **densegen** to uncover higher-order transcription factor binding site combinations.

7.  [**latdna**](src/dnadesign/latdna)

      Pipeline for latent space analysis of DNA sequences.

8. [**cruncher**](src/dnadesign/cruncher)

      Pipeline that parses TF position-weight matrices (MEME, JASPAR, etc.) via plug-in parsers, and then runs a discrete Categorical Gibbs optimiser (or other plug-ins) to discover short DNA sequences that score highly on one or more TFs.

9. [**tfkdanalysis**](src/dnadesign/tfkdanalysis)

      Pipeline for analyzing transcription factor knockdown (TFKD) effects using PPTP-seq (Promoter responses to TF perturbation sequencing) data—a high-throughput approach described in [Han *et al.* (2023)](https://doi.org/10.1038/s41467-023-41572-4).

12. [**aligner**](src/dnadesign/aligner)

      Wrapper for Biopython's [PairwiseAligner](https://biopython.org/docs/dev/Tutorial/chapter_pairwise.html#chapter-pairwise), which is a class for computing Needleman–Wunsch global alignment scores between nucleotide sequences.

13. [**permuter**](src/dnadesign/permuter)

      Pipeline for biological sequence permutation and subsequent evaluation workflows.
14. [**archived**](src/dnadesign/archived)

      Contains a mix of old legacy projects and prototypes.

---

### Installation

This repo is managed with [**uv**](https://docs.astral.sh/uv/):

- `pyproject.toml` declares dependencies (runtime + optional extras).
- `uv.lock` is the fully pinned dependency graph.
- `.venv/` is the project virtual environment (created automatically by uv).

**Two key commands:**

- `uv sync` installs everything from the lockfile into `.venv` (and creates `.venv` if it doesn’t exist).
- `uv run <cmd>` runs commands inside the project environment without requiring `source .venv/bin/activate`.

#### Install uv

macOS/Linux (for other OSs see [here](https://docs.astral.sh/uv/getting-started/installation/)):
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
# ensure your uv bin dir is on PATH
```

#### Clone repo
```bash
git clone https://github.com/e-south/dnadesign.git
cd dnadesign
```

#### Local install

This is the default way to start working with most pipelines. Read [**here**](./docs/INSTALL_BU_SCC.md) for added details on building an environment with CUDA/GPU support.

1. Ensure Python 3.12 is available:

      ```bash
      uv python install 3.12
      ```

2. Create/sync the environment from the committed lockfile:

      ```bash
      uv sync --locked
      ```

3. Sanity checks:

      ```bash
      uv run python -c "import dnadesign, pandas, pyarrow; print('ok')"
      uv run usr ls || true
      ```

#### Dev tools (tests + lint)

Dev tooling is opt-in via a dependency group.

```bash
uv sync --locked --group dev
uv run ruff --version
uv run pytest -q
```

---

#### Running `dnadesign` CLIs

**This repo defines console scripts which can be run via:**

Option A: no `.venv` activation — use `uv run`

```bash
uv run usr --help
uv run usr ls

uv run opal --help
uv run dense --help
uv run infer --help
uv run cluster --help
uv run permuter --help
uv run baserender --help
```

Option B: traditional — activate `.venv`

```bash
source .venv/bin/activate
usr --help
usr ls
deactivate
```

---

#### Running notebooks

There are two ways to use marimo in `dnadesign`:

##### 1. Install marimo into the project

```bash
uv sync --locked --group notebooks
uv run marimo edit notebooks/foo.py
```

This runs marimo inside your project environment, so it can import `dnadesign` and anything in `uv.lock`.

##### 2. Sandboxed / self-contained marimo notebooks (inline dependencies)

Marimo can manage per-notebook sandbox environments using inline metadata. This is great for sharable notebooks.

1. Create/edit a sandbox notebook (marimo installed temporarily via uvx).

      ```bash
      uvx marimo edit --sandbox notebooks/sandbox_example.py
      ```

2. Run a sandbox notebook as a script.

      ```bash
      uv run notebooks/sandbox_example.py
      ```

3. Make the sandbox notebook use your local `dnadesign` repo in editable mode.

      From the repo root:

      ```bash
      uv add --script notebooks/sandbox_example.py . --editable
      ```

      This writes inline metadata into the notebook so its sandbox can install dnadesign from your local checkout in editable mode.

4. Add/remove sandbox dependencies (only affects the notebook file)

      ```bash
      uv add    --script notebooks/sandbox_example.py numpy
      uv remove --script notebooks/sandbox_example.py numpy
      ```

> **Note:** You can also run claude code/codex in the terminal and ask it to edit a marimo notebook on your behalf. Make sure that you run your notebook with the [watch](https://docs.marimo.io/api/watch/) flag turned on, like `marimo edit --watch notebook.py`, to see updates appear live whenever agents makes a change.

---

#### Maintaining dependencies

If you want to change dependencies, prefer `uv add` / `uv remove`:

- Add a runtime dependency:

  ```bash
  uv add <package>
  ```

- Add to a dependency group (examples):

  ```bash
  uv add --group dev <package>
  uv add --group notebooks marimo
  ```

- Remove:

  ```bash
  uv remove <package>
  ```

Then commit `pyproject.toml` + `uv.lock`.

If you edit `pyproject.toml` by hand, regenerate `uv.lock`:

```bash
uv lock
```

New users should then run:

```bash
uv sync --locked
```

---

@e-south
